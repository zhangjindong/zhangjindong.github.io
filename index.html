<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/css/highlight.css">

  
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="木瓜">
<meta name="twitter:card" content="summary"><meta name="generator" content="Hexo 7.1.1"></head>

<body>
  <div id="wrapper">
    <header id="header">
  <h1 id="title">
    <a href="/">Hexo</a>
  </h1>
  <nav>
    
    
      
      <a class="nav-link" href="/">Home</a>
    
      
        <span class="nav-spacer">×</span>
      
      <a class="nav-link" href="/archives">Archives</a>
    
    
  </nav>
</header>

    <div id="content">
      
  
    <article id="post-unit-testing-rxjs-observables-a-practical-guide" class="article article-type-post" itemprop="blogPost" itemscope>
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h2 class="article-title" itemprop="name">
      <a href="/2024/04/15/unit-testing-rxjs-observables-a-practical-guide/">RxJS Observables 单元测试 – 实用指南</a>
      
    </h2>
  


        <div class="article-meta">
          <time class="article-date" datetime="2024-04-15T05:34:19.000Z" itemprop="datePublished">四月 15, 2024, 1:34 下午</time>

          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
      
        <p>由于 RxJS 观察链的异步特性，对其进行单元测试可能具有挑战性。我们最新的技术博客着眼于简化这个过程。</p>
<p>目录表</p>
<ul>
<li>RxJS 可观察对象单元测试中的挑战</li>
<li>技术的先决条件</li>
<li>单元测试目标</li>
<li>RxJS 观察链单元测试: 解决方案概述</li>
<li>单元测试 RxJS 观察链: 解决方案示例</li>
<li>RxJS 观察链单元测试: 解决方案概述</li>
<li>进一步的资源</li>
<li>附录 A: 考虑单元测试 RxJS 观察链的替代解决方案</li>
</ul>
<h2 id="RxJS-可观察对象单元测试中的挑战"><a href="#RxJS-可观察对象单元测试中的挑战" class="headerlink" title="RxJS 可观察对象单元测试中的挑战"></a>RxJS 可观察对象单元测试中的挑战</h2><p>Adaptive 为其资本市场客户构建的用户界面(ui)通常是“反应性的”，这意味着它们的视图会随着金融市场的变化而实时更新。在 Adaptive，我们倾向于使用 RxJS 的可观察对象来管理应用程序状态，将它们绑定到 UI 组件上，这样当可观察对象发出时，视图就会更新。在应用程序的状态层中，我们经常通过将操作符函数传递给 pipe()方法来定义重要的观察链。这些观察链定义了如何组合来自多个数据源的数据，并将其转换为 UI 组件要使用的视图模型对象。</p>
<p>这些观察链中逻辑的正确性通常对应用程序的行为至关重要，<strong>但单元测试可能具有挑战性，因为随着时间的推移，可观察对象会异步发出多个值。</strong></p>
<p>那么，我们如何才能有效地对 RxJS 观察链进行单元测试，以验证它们的行为是否符合我们的预期呢?</p>
<h2 id="技术的先决条件"><a href="#技术的先决条件" class="headerlink" title="技术的先决条件"></a>技术的先决条件</h2><p>假定读者熟悉 TypeScript、RxJS 和单元测试框架(如 Vitest 或 Jest)。本文将不关注任何特定的 UI 框架或视图&#x2F;组件库。如果你正在使用 RxJS 以响应式的方式管理应用状态，那么无论你使用的是 React、Vue.js、Angular 还是其他框架，这些内容都应该是相关的。</p>
<p>本文中的示例代码可以在随附的 GitHub repo 中找到。在本文中，您可以使用 repo 中的标记跟踪示例的开发进度。</p>
<h2 id="单元测试目标"><a href="#单元测试目标" class="headerlink" title="单元测试目标"></a>单元测试目标</h2><p>Adaptive 团队希望能够测试由观察链创建的可观察对象发出的各种状态排列，并通过它所依赖的上游源可观察对象向所述链提供各种输入。</p>
<p>我们想要测试的单元是按原样导出的有状态可观察对象，或者是接受键(比如实体 ID)并返回可观察对象的函数。例如，下面的观察链，本文将演示如何进行单元测试。</p>
<p>Stage 1: state.ts</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">    <span class="title class_">Observable</span>,</span><br><span class="line">    map,</span><br><span class="line">    mergeWith,</span><br><span class="line">    scan,</span><br><span class="line">    startWith</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">    pricesDto$,</span><br><span class="line">    resetPrices$</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&quot;./service&quot;</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="attr">prices$</span>: <span class="title class_">Observable</span> &lt; <span class="title class_">Record</span> &lt; string, number &gt;&gt; = pricesDto$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">scan</span>(</span><br><span class="line">        <span class="function">(<span class="params">accum, current</span>) =&gt;</span> (&#123;</span><br><span class="line">            ...accum,</span><br><span class="line">            [current.<span class="property">symbol</span>]: current.<span class="property">price</span>,</span><br><span class="line">        &#125;), &#123;&#125;</span><br><span class="line">    ),</span><br><span class="line">    <span class="title function_">mergeWith</span>(resetPrices$.<span class="title function_">pipe</span>(<span class="title function_">map</span>(<span class="function">() =&gt;</span> (&#123;&#125;)))),</span><br><span class="line">    <span class="title function_">startWith</span>(&#123;&#125;)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>在开发我们在这里展示的模式之前，我们探索并拒绝了附录 A: 为 RxJS 观察链单元测试考虑的替代解决方案中描述的一些方法。</p>
<h2 id="RxJS-观察链单元测试-解决方案概述"><a href="#RxJS-观察链单元测试-解决方案概述" class="headerlink" title="RxJS 观察链单元测试: 解决方案概述"></a>RxJS 观察链单元测试: 解决方案概述</h2><p>正如我们将在下面演示的那样，我们通过使用 spy 函数订阅被测对象来实现我们的测试目标，这样我们就可以断言所发出的内容，并用 RxJS 主题模拟源可观察对象。我们通过一个非常小的实用函数 spyOnObservable()来实现这一点，它抽象了与监视观察者相关的样板文件。我们在这里使用的是 Vitest，但如果您使用的是 Jest，则语义非常相似。如果您使用不同的测试库(如 Mocha、Jasmine 或 Qunit)，语义可能会有点不同，但概念和功能应该很容易转移。</p>
<p>spyOnObservable.ts</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">    <span class="title class_">Observable</span>,</span><br><span class="line">    <span class="title class_">Subscription</span></span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">    <span class="title class_">Mock</span></span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;vitest&#x27;</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">- Utility function for testing observables.</span></span><br><span class="line"><span class="comment">- Returns an object containing mock observer functions.</span></span><br><span class="line"><span class="comment">-</span></span><br><span class="line"><span class="comment">- To ensure your test does not cause a memory leak, assert that `complete`</span></span><br><span class="line"><span class="comment">- has been called; this will verify that this utility has unsubscribed</span></span><br><span class="line"><span class="comment">- from the observable under test. Alternatively, explicitly unsubscribe</span></span><br><span class="line"><span class="comment">- the subscription that is returned.</span></span><br><span class="line"><span class="comment">-</span></span><br><span class="line"><span class="comment">- Example usage:</span></span><br><span class="line"><span class="comment">-</span></span><br><span class="line"><span class="comment">- const &#123; next, error, complete, subscription, latestEmission, emissionCount &#125; =</span></span><br><span class="line"><span class="comment">-      spyOnObservable(observableToTest$.pipe(take(1)))</span></span><br><span class="line"><span class="comment">-</span></span><br><span class="line"><span class="comment">- expect(next).toHaveBeenCalledTimes(1)</span></span><br><span class="line"><span class="comment">- expect(next).toHaveBeenCalledWith(someValue)</span></span><br><span class="line"><span class="comment">- expect(latestEmission()).toBe(someValue)</span></span><br><span class="line"><span class="comment">- expect(error).not.toHaveBeenCalled()</span></span><br><span class="line"><span class="comment">- subscription.unsubscribe()</span></span><br><span class="line"><span class="comment">- expect(complete).toHaveBeenCalled()</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">spyOnObservable</span>(<span class="params">observable$: Observable &lt; unknown &gt; </span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="attr">next</span>: <span class="title class_">Mock</span> &lt; any, any &gt; = vi.<span class="title function_">fn</span>()</span><br><span class="line">    <span class="keyword">const</span> <span class="attr">error</span>: <span class="title class_">Mock</span> &lt; any, any &gt; = vi.<span class="title function_">fn</span>()</span><br><span class="line">    <span class="keyword">const</span> <span class="attr">complete</span>: <span class="title class_">Mock</span> &lt; any, any &gt; = vi.<span class="title function_">fn</span>()</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">emissionCount</span> = (<span class="params"></span>) =&gt; next.<span class="property">mock</span>.<span class="property">calls</span>.<span class="property">length</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">latestEmission</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> next.<span class="property">mock</span>.<span class="property">calls</span>.<span class="title function_">at</span>(-<span class="number">1</span>) ![<span class="number">0</span>]</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;expected next to have been called&#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> <span class="attr">subscription</span>: <span class="title class_">Subscription</span></span><br><span class="line">    subscription = observable$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">        next,</span><br><span class="line">        error,</span><br><span class="line">        <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123;</span><br><span class="line">            subscription?.<span class="title function_">unsubscribe</span>()</span><br><span class="line">            <span class="title function_">complete</span>()</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        next,</span><br><span class="line">        error,</span><br><span class="line">        complete,</span><br><span class="line">        subscription,</span><br><span class="line">        latestEmission,</span><br><span class="line">        emissionCount</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="单元测试-RxJS-观察链-解决方案示例"><a href="#单元测试-RxJS-观察链-解决方案示例" class="headerlink" title="单元测试 RxJS 观察链: 解决方案示例"></a>单元测试 RxJS 观察链: 解决方案示例</h2><p>我们将使用以下虚构的用例来演示如何在现实生活中应用它。我们选择了一个用例，它比我们在现实生活中遇到的用例更简单，但具有足够的复杂性来说明问题以及我们将如何解决它。</p>
<p>假设我们有一个需要显示实时更新的金融工具价格的应用程序。为了做到这一点，我们需要一个从符号到价格的查找表，每个我们有价格的工具都有一个条目。我们有一个可观察对象，它将在每次价格更新时发出一个对象，其中包含该表的最新值。这是我们想要测试的可观察对象。</p>
<p><strong>被测试的可观察对象依赖于两个源可观察对象:</strong></p>
<ul>
<li>第一个将发出一个对象，其中包含一个符号和价格的单个工具，每次有一个价格更新的工具。(在现实世界的应用中，这个可观察对象将是 WebSocket 流上的抽象。)</li>
<li>第二个表示一个事件，当触发时，应该将价格查找表的状态重置为其初始空状态。</li>
</ul>
<p>这个可观察对象的初始实现如下所示。然而，在没有测试的情况下，我们不能确定它的行为是否符合预期。</p>
<p>Stage 1: state.ts</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">    <span class="title class_">Observable</span>,</span><br><span class="line">    map,</span><br><span class="line">    mergeWith,</span><br><span class="line">    scan,</span><br><span class="line">    startWith</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">    pricesDto$,</span><br><span class="line">    resetPrices$</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&quot;./service&quot;</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="attr">prices$</span>: <span class="title class_">Observable</span> &lt; <span class="title class_">Record</span> &lt; string, number &gt;&gt; = pricesDto$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">scan</span>(</span><br><span class="line">        <span class="function">(<span class="params">accum, current</span>) =&gt;</span> (&#123;</span><br><span class="line">            ...accum,</span><br><span class="line">            [current.<span class="property">symbol</span>]: current.<span class="property">price</span>,</span><br><span class="line">        &#125;), &#123;&#125;</span><br><span class="line">    ),</span><br><span class="line">    <span class="title function_">mergeWith</span>(resetPrices$.<span class="title function_">pipe</span>(<span class="title function_">map</span>(<span class="function">() =&gt;</span> (&#123;&#125;)))),</span><br><span class="line">    <span class="title function_">startWith</span>(&#123;&#125;)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>有关其他上下文，请参见 service。t 和 model。Ts</p>
<p>让我们设置测试文件。</p>
<p>Stage 1: state.test.ts</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">    <span class="title class_">Subject</span></span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">    <span class="title class_">Price</span></span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;./model&#x27;</span></span><br><span class="line"><span class="comment">// create subjects to mock out the source observables that our</span></span><br><span class="line"><span class="comment">// observable under test depends on</span></span><br><span class="line"><span class="keyword">const</span> mockPricesDto$ = <span class="keyword">new</span> <span class="title class_">Subject</span> &lt; <span class="title class_">Price</span> &gt; ()</span><br><span class="line"><span class="keyword">const</span> mockResetPrices$ = <span class="keyword">new</span> <span class="title class_">Subject</span> &lt; <span class="keyword">void</span> &gt; ()</span><br><span class="line"><span class="comment">// use doMock() rather than mock() so we can reference the</span></span><br><span class="line"><span class="comment">// variables containing the mock observables. mock() is hoisted</span></span><br><span class="line"><span class="comment">// so it does not allow referencing variables in the file scope.</span></span><br><span class="line"><span class="comment">// see https://vitest.dev/api/vi#vi-mock and</span></span><br><span class="line"><span class="comment">// https://vitest.dev/api/vi#vi-domock</span></span><br><span class="line">vi.<span class="title function_">doMock</span>(<span class="string">&#x27;./service&#x27;</span>, <span class="function">() =&gt;</span> (&#123;</span><br><span class="line">    <span class="attr">pricesDto$</span>: mockPricesDto$,</span><br><span class="line">    <span class="attr">resetPrices$</span>: mockResetPrices$,</span><br><span class="line">&#125;))</span><br><span class="line"><span class="comment">// we need to dynamically import the observable under test</span></span><br><span class="line"><span class="comment">// after we call vi.doMock. see https://vitest.dev/api/vi#vi-domock</span></span><br><span class="line"><span class="keyword">const</span> &#123;</span><br><span class="line">    prices$</span><br><span class="line">&#125; = <span class="keyword">await</span> <span class="keyword">import</span>(<span class="string">&#x27;./state&#x27;</span>)</span><br><span class="line"><span class="title function_">describe</span>(<span class="string">&#x27;prices$&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// we are now ready to add our tests here</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>现在我们已经设置了测试文件的外壳，让我们添加一些基本断言。注意我们的 spyOnObservable()实用函数的用法。</p>
<p>Stage 2: state.test.ts</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">    <span class="title class_">Subject</span></span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">    <span class="title class_">Price</span></span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;./model&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">    spyOnObservable</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;./spyOnObservable&#x27;</span></span><br><span class="line"><span class="comment">// create subjects to mock out the source observables that our</span></span><br><span class="line"><span class="comment">// observable under test depends on</span></span><br><span class="line"><span class="keyword">const</span> mockPricesDto$ = <span class="keyword">new</span> <span class="title class_">Subject</span> &lt; <span class="title class_">Price</span> &gt; ()</span><br><span class="line"><span class="keyword">const</span> mockResetPrices$ = <span class="keyword">new</span> <span class="title class_">Subject</span> &lt; <span class="keyword">void</span> &gt; ()</span><br><span class="line"><span class="comment">// use doMock() rather than mock() so we can reference the</span></span><br><span class="line"><span class="comment">// variables containing the mock observables. mock() is hoisted</span></span><br><span class="line"><span class="comment">// so it does not allow referencing variables in the file scope.</span></span><br><span class="line"><span class="comment">// see https://vitest.dev/api/vi#vi-mock and</span></span><br><span class="line"><span class="comment">// https://vitest.dev/api/vi#vi-domock</span></span><br><span class="line">vi.<span class="title function_">doMock</span>(<span class="string">&#x27;./service&#x27;</span>, <span class="function">() =&gt;</span> (&#123;</span><br><span class="line">    <span class="attr">pricesDto$</span>: mockPricesDto$,</span><br><span class="line">    <span class="attr">resetPrices$</span>: mockResetPrices$,</span><br><span class="line">&#125;))</span><br><span class="line"><span class="comment">// we need to dynamically import the observable under test</span></span><br><span class="line"><span class="comment">// after we call vi.doMock. see https://vitest.dev/api/vi#vi-domock</span></span><br><span class="line"><span class="keyword">const</span> &#123;</span><br><span class="line">    prices$</span><br><span class="line">&#125; = <span class="keyword">await</span> <span class="keyword">import</span>(<span class="string">&#x27;./state&#x27;</span>)</span><br><span class="line"><span class="title function_">describe</span>(<span class="string">&#x27;prices$&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// spy on the observable under test, using the spyOnObservable utility</span></span><br><span class="line">    <span class="keyword">const</span> &#123;</span><br><span class="line">        latestEmission,</span><br><span class="line">        error,</span><br><span class="line">        subscription</span><br><span class="line">    &#125; = <span class="title function_">spyOnObservable</span>(prices$)</span><br><span class="line">    <span class="comment">// ensure we unsubscribe when we are done to avoid memory leaks</span></span><br><span class="line">    <span class="title function_">afterAll</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        subscription.<span class="title function_">unsubscribe</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="title function_">it</span>(<span class="string">&#x27;should initially emit empty object&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">expect</span>(<span class="title function_">latestEmission</span>()).<span class="title function_">toEqual</span>(&#123;&#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="title function_">it</span>(<span class="string">&#x27;should not error&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">expect</span>(error).<span class="property">not</span>.<span class="title function_">toBeCalled</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>我们的测试通过了。</p>
<p><img src="/2024/04/15/unit-testing-rxjs-observables-a-practical-guide/image.png" alt="alt text"></p>
<p>RxJS 可观察对象: 第二阶段——测试通过</p>
<p>到目前为止一切顺利。现在，让我们添加一些断言，说明源可观察对象 pricesDto$发出时的行为。</p>
<p>Stage 3: state.test.ts</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">    <span class="title class_">Subject</span></span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">    <span class="title class_">Price</span></span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;./model&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">    spyOnObservable</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;./spyOnObservable&#x27;</span></span><br><span class="line"><span class="comment">// create subjects to mock out the source observables that our</span></span><br><span class="line"><span class="comment">// observable under test depends on</span></span><br><span class="line"><span class="keyword">const</span> mockPricesDto$ = <span class="keyword">new</span> <span class="title class_">Subject</span> &lt; <span class="title class_">Price</span> &gt; ()</span><br><span class="line"><span class="keyword">const</span> mockResetPrices$ = <span class="keyword">new</span> <span class="title class_">Subject</span> &lt; <span class="keyword">void</span> &gt; ()</span><br><span class="line"><span class="comment">// use doMock() rather than mock() so we can reference the</span></span><br><span class="line"><span class="comment">// variables containing the mock observables. mock() is hoisted</span></span><br><span class="line"><span class="comment">// so it does not allow referencing variables in the file scope.</span></span><br><span class="line"><span class="comment">// see https://vitest.dev/api/vi#vi-mock and</span></span><br><span class="line"><span class="comment">// https://vitest.dev/api/vi#vi-domock</span></span><br><span class="line">vi.<span class="title function_">doMock</span>(<span class="string">&#x27;./service&#x27;</span>, <span class="function">() =&gt;</span> (&#123;</span><br><span class="line">    <span class="attr">pricesDto$</span>: mockPricesDto$,</span><br><span class="line">    <span class="attr">resetPrices$</span>: mockResetPrices$,</span><br><span class="line">&#125;))</span><br><span class="line"><span class="comment">// we need to dynamically import the observable under test</span></span><br><span class="line"><span class="comment">// after we call vi.doMock. see https://vitest.dev/api/vi#vi-domock</span></span><br><span class="line"><span class="keyword">const</span> &#123;</span><br><span class="line">    prices$</span><br><span class="line">&#125; = <span class="keyword">await</span> <span class="keyword">import</span>(<span class="string">&#x27;./state&#x27;</span>)</span><br><span class="line"><span class="title function_">describe</span>(<span class="string">&#x27;prices$&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// spy on the observable under test, using the spyOnObservable utility</span></span><br><span class="line">    <span class="keyword">const</span> &#123;</span><br><span class="line">        latestEmission,</span><br><span class="line">        error,</span><br><span class="line">        subscription</span><br><span class="line">    &#125; = <span class="title function_">spyOnObservable</span>(prices$)</span><br><span class="line">    <span class="comment">// ensure we unsubscribe when we are done to avoid memory leaks</span></span><br><span class="line">    <span class="title function_">afterAll</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        subscription.<span class="title function_">unsubscribe</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="title function_">it</span>(<span class="string">&#x27;should initially emit empty object&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">expect</span>(<span class="title function_">latestEmission</span>()).<span class="title function_">toEqual</span>(&#123;&#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="title function_">it</span>(<span class="string">&#x27;should emit object containing latest prices after pricesDto$ emits&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// call next() on the subject that mocks out the source observable</span></span><br><span class="line">        <span class="comment">// priceDto$ that the observable under test depends on to simulate</span></span><br><span class="line">        <span class="comment">// that observable emitting prices, and ensure the new price is</span></span><br><span class="line">        <span class="comment">// emitted as expected in the observable under test</span></span><br><span class="line">        mockPricesDto$.<span class="title function_">next</span>(&#123;</span><br><span class="line">            <span class="attr">symbol</span>: <span class="string">&#x27;XOM&#x27;</span>,</span><br><span class="line">            <span class="attr">price</span>: <span class="number">48.17</span></span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="title function_">expect</span>(<span class="title function_">latestEmission</span>()).<span class="title function_">toEqual</span>(&#123;</span><br><span class="line">            <span class="attr">XOM</span>: <span class="number">48.17</span></span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="comment">// add another instrument/price, ensure both instruments</span></span><br><span class="line">        <span class="comment">// appear in the resulting emission</span></span><br><span class="line">        mockPricesDto$.<span class="title function_">next</span>(&#123;</span><br><span class="line">            <span class="attr">symbol</span>: <span class="string">&#x27;BA&#x27;</span>,</span><br><span class="line">            <span class="attr">price</span>: <span class="number">218.93</span></span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="title function_">expect</span>(<span class="title function_">latestEmission</span>()).<span class="title function_">toEqual</span>(&#123;</span><br><span class="line">            <span class="attr">XOM</span>: <span class="number">48.17</span>,</span><br><span class="line">            <span class="attr">BA</span>: <span class="number">218.93</span></span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="comment">// update the price of the first instrument, ensure the price is</span></span><br><span class="line">        <span class="comment">// updated in the resulting emission</span></span><br><span class="line">        mockPricesDto$.<span class="title function_">next</span>(&#123;</span><br><span class="line">            <span class="attr">symbol</span>: <span class="string">&#x27;XOM&#x27;</span>,</span><br><span class="line">            <span class="attr">price</span>: <span class="number">48.21</span></span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="title function_">expect</span>(<span class="title function_">latestEmission</span>()).<span class="title function_">toEqual</span>(&#123;</span><br><span class="line">            <span class="attr">XOM</span>: <span class="number">48.21</span>,</span><br><span class="line">            <span class="attr">BA</span>: <span class="number">218.93</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="title function_">it</span>(<span class="string">&#x27;should not error&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">expect</span>(error).<span class="property">not</span>.<span class="title function_">toBeCalled</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>太好了，我们的测试仍然通过了</p>
<p><img src="/2024/04/15/unit-testing-rxjs-observables-a-practical-guide/image-1.png" alt="alt text"></p>
<p>RxJS 可观察对象: 阶段 3——测试通过</p>
<p>现在让我们为重置事件添加一个断言。</p>
<p>Stage 4: state.test.ts</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">    <span class="title class_">Subject</span></span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">    <span class="title class_">Price</span></span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;./model&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">    spyOnObservable</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;./spyOnObservable&#x27;</span></span><br><span class="line"><span class="comment">// create subjects to mock out the source observables that our</span></span><br><span class="line"><span class="comment">// observable under test depends on</span></span><br><span class="line"><span class="keyword">const</span> mockPricesDto$ = <span class="keyword">new</span> <span class="title class_">Subject</span> &lt; <span class="title class_">Price</span> &gt; ()</span><br><span class="line"><span class="keyword">const</span> mockResetPrices$ = <span class="keyword">new</span> <span class="title class_">Subject</span> &lt; <span class="keyword">void</span> &gt; ()</span><br><span class="line"><span class="comment">// use doMock() rather than mock() so we can reference the</span></span><br><span class="line"><span class="comment">// variables containing the mock observables. mock() is hoisted</span></span><br><span class="line"><span class="comment">// so it does not allow referencing variables in the file scope.</span></span><br><span class="line"><span class="comment">// see https://vitest.dev/api/vi#vi-mock and</span></span><br><span class="line"><span class="comment">// https://vitest.dev/api/vi#vi-domock</span></span><br><span class="line">vi.<span class="title function_">doMock</span>(<span class="string">&#x27;./service&#x27;</span>, <span class="function">() =&gt;</span> (&#123;</span><br><span class="line">    <span class="attr">pricesDto$</span>: mockPricesDto$,</span><br><span class="line">    <span class="attr">resetPrices$</span>: mockResetPrices$,</span><br><span class="line">&#125;))</span><br><span class="line"><span class="comment">// we need to dynamically import the observable under test</span></span><br><span class="line"><span class="comment">// after we call vi.doMock. see https://vitest.dev/api/vi#vi-domock</span></span><br><span class="line"><span class="keyword">const</span> &#123;</span><br><span class="line">    prices$</span><br><span class="line">&#125; = <span class="keyword">await</span> <span class="keyword">import</span>(<span class="string">&#x27;./state&#x27;</span>)</span><br><span class="line"><span class="title function_">describe</span>(<span class="string">&#x27;prices$&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// spy on the observable under test, using the spyOnObservable utility</span></span><br><span class="line">    <span class="keyword">const</span> &#123;</span><br><span class="line">        latestEmission,</span><br><span class="line">        error,</span><br><span class="line">        subscription</span><br><span class="line">    &#125; = <span class="title function_">spyOnObservable</span>(prices$)</span><br><span class="line">    <span class="comment">// ensure we unsubscribe when we are done to avoid memory leaks</span></span><br><span class="line">    <span class="title function_">afterAll</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        subscription.<span class="title function_">unsubscribe</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="title function_">it</span>(<span class="string">&#x27;should initially emit empty object&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">expect</span>(<span class="title function_">latestEmission</span>()).<span class="title function_">toEqual</span>(&#123;&#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="title function_">it</span>(<span class="string">&#x27;should emit object containing latest prices after pricesDto$ emits&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// call next() on the subject that mocks out the source observable</span></span><br><span class="line">        <span class="comment">// priceDto$ that the observable under test depends on, to simulate</span></span><br><span class="line">        <span class="comment">// that observable emitting prices, and ensure the new price is</span></span><br><span class="line">        <span class="comment">// emitted as expected in the observable under test</span></span><br><span class="line">        mockPricesDto$.<span class="title function_">next</span>(&#123;</span><br><span class="line">            <span class="attr">symbol</span>: <span class="string">&#x27;XOM&#x27;</span>,</span><br><span class="line">            <span class="attr">price</span>: <span class="number">48.17</span></span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="title function_">expect</span>(<span class="title function_">latestEmission</span>()).<span class="title function_">toEqual</span>(&#123;</span><br><span class="line">            <span class="attr">XOM</span>: <span class="number">48.17</span></span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="comment">// add another instrument/price, ensure both instruments</span></span><br><span class="line">        <span class="comment">// appear in the resulting emission</span></span><br><span class="line">        mockPricesDto$.<span class="title function_">next</span>(&#123;</span><br><span class="line">            <span class="attr">symbol</span>: <span class="string">&#x27;BA&#x27;</span>,</span><br><span class="line">            <span class="attr">price</span>: <span class="number">218.93</span></span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="title function_">expect</span>(<span class="title function_">latestEmission</span>()).<span class="title function_">toEqual</span>(&#123;</span><br><span class="line">            <span class="attr">XOM</span>: <span class="number">48.17</span>,</span><br><span class="line">            <span class="attr">BA</span>: <span class="number">218.93</span></span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="comment">// update the price of the first instrument, ensure the price is</span></span><br><span class="line">        <span class="comment">// updated in the resulting emission</span></span><br><span class="line">        mockPricesDto$.<span class="title function_">next</span>(&#123;</span><br><span class="line">            <span class="attr">symbol</span>: <span class="string">&#x27;XOM&#x27;</span>,</span><br><span class="line">            <span class="attr">price</span>: <span class="number">48.21</span></span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="title function_">expect</span>(<span class="title function_">latestEmission</span>()).<span class="title function_">toEqual</span>(&#123;</span><br><span class="line">            <span class="attr">XOM</span>: <span class="number">48.21</span>,</span><br><span class="line">            <span class="attr">BA</span>: <span class="number">218.93</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="title function_">it</span>(<span class="string">&#x27;should emit empty object after resetPrices$ emits&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// call next() on the subject that mocks out the source observable</span></span><br><span class="line">        <span class="comment">// resetPrices$ that the observable under test depends on, to simulate</span></span><br><span class="line">        <span class="comment">// that observable emitting, and ensure that the prices lookup table</span></span><br><span class="line">        <span class="comment">// is reset to an empty object</span></span><br><span class="line">        mockResetPrices$.<span class="title function_">next</span>()</span><br><span class="line">        <span class="title function_">expect</span>(<span class="title function_">latestEmission</span>()).<span class="title function_">toEqual</span>(&#123;&#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="title function_">it</span>(<span class="string">&#x27;should not error&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">expect</span>(error).<span class="property">not</span>.<span class="title function_">toBeCalled</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>太好了，测试又通过了。</p>
<p><img src="/2024/04/15/unit-testing-rxjs-observables-a-practical-guide/image-2.png" alt="alt text"></p>
<p>RxJS 可观察对象: 阶段 4 -测试通过</p>
<p>现在，让我们添加一个断言，即在重置后流入的下一个价格中，查找表中只有新价格。<br>Stage 5: state.test.ts</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">    <span class="title class_">Subject</span></span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">    <span class="title class_">Price</span></span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;./model&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">    spyOnObservable</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;./spyOnObservable&#x27;</span></span><br><span class="line"><span class="comment">// create subjects to mock out the source observables that our</span></span><br><span class="line"><span class="comment">// observable under test depends on</span></span><br><span class="line"><span class="keyword">const</span> mockPricesDto$ = <span class="keyword">new</span> <span class="title class_">Subject</span> &lt; <span class="title class_">Price</span> &gt; ()</span><br><span class="line"><span class="keyword">const</span> mockResetPrices$ = <span class="keyword">new</span> <span class="title class_">Subject</span> &lt; <span class="keyword">void</span> &gt; ()</span><br><span class="line"><span class="comment">// use doMock() rather than mock() so we can reference the</span></span><br><span class="line"><span class="comment">// variables containing the mock observables. mock() is hoisted</span></span><br><span class="line"><span class="comment">// so it does not allow referencing variables in the file scope.</span></span><br><span class="line"><span class="comment">// see https://vitest.dev/api/vi#vi-mock and</span></span><br><span class="line"><span class="comment">// https://vitest.dev/api/vi#vi-domock</span></span><br><span class="line">vi.<span class="title function_">doMock</span>(<span class="string">&#x27;./service&#x27;</span>, <span class="function">() =&gt;</span> (&#123;</span><br><span class="line">    <span class="attr">pricesDto$</span>: mockPricesDto$,</span><br><span class="line">    <span class="attr">resetPrices$</span>: mockResetPrices$,</span><br><span class="line">&#125;))</span><br><span class="line"><span class="comment">// we need to dynamically import the observable under test</span></span><br><span class="line"><span class="comment">// after we call vi.doMock. see https://vitest.dev/api/vi#vi-domock</span></span><br><span class="line"><span class="keyword">const</span> &#123;</span><br><span class="line">    prices$</span><br><span class="line">&#125; = <span class="keyword">await</span> <span class="keyword">import</span>(<span class="string">&#x27;./state&#x27;</span>)</span><br><span class="line"><span class="title function_">describe</span>(<span class="string">&#x27;prices$&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// spy on the observable under test, using the spyOnObservable utility</span></span><br><span class="line">    <span class="keyword">const</span> &#123;</span><br><span class="line">        latestEmission,</span><br><span class="line">        error,</span><br><span class="line">        subscription</span><br><span class="line">    &#125; = <span class="title function_">spyOnObservable</span>(prices$)</span><br><span class="line">    <span class="comment">// ensure we unsubscribe when we are done to avoid memory leaks</span></span><br><span class="line">    <span class="title function_">afterAll</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        subscription.<span class="title function_">unsubscribe</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="title function_">it</span>(<span class="string">&#x27;should initially emit empty object&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">expect</span>(<span class="title function_">latestEmission</span>()).<span class="title function_">toEqual</span>(&#123;&#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="title function_">it</span>(<span class="string">&#x27;should emit object containing latest prices after pricesDto$ emits&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// call next() on the subject that mocks out the source observable</span></span><br><span class="line">        <span class="comment">// priceDto$ that the observable under test depends on, to simulate</span></span><br><span class="line">        <span class="comment">// that observable emitting prices, and ensure the new price is</span></span><br><span class="line">        <span class="comment">// emitted as expected in the observable under test</span></span><br><span class="line">        mockPricesDto$.<span class="title function_">next</span>(&#123;</span><br><span class="line">            <span class="attr">symbol</span>: <span class="string">&#x27;XOM&#x27;</span>,</span><br><span class="line">            <span class="attr">price</span>: <span class="number">48.17</span></span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="title function_">expect</span>(<span class="title function_">latestEmission</span>()).<span class="title function_">toEqual</span>(&#123;</span><br><span class="line">            <span class="attr">XOM</span>: <span class="number">48.17</span></span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="comment">// add another instrument/price, ensure both instruments</span></span><br><span class="line">        <span class="comment">// appear in the resulting emission</span></span><br><span class="line">        mockPricesDto$.<span class="title function_">next</span>(&#123;</span><br><span class="line">            <span class="attr">symbol</span>: <span class="string">&#x27;BA&#x27;</span>,</span><br><span class="line">            <span class="attr">price</span>: <span class="number">218.93</span></span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="title function_">expect</span>(<span class="title function_">latestEmission</span>()).<span class="title function_">toEqual</span>(&#123;</span><br><span class="line">            <span class="attr">XOM</span>: <span class="number">48.17</span>,</span><br><span class="line">            <span class="attr">BA</span>: <span class="number">218.93</span></span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="comment">// update the price of the first instrument, ensure the price is</span></span><br><span class="line">        <span class="comment">// updated in the resulting emission</span></span><br><span class="line">        mockPricesDto$.<span class="title function_">next</span>(&#123;</span><br><span class="line">            <span class="attr">symbol</span>: <span class="string">&#x27;XOM&#x27;</span>,</span><br><span class="line">            <span class="attr">price</span>: <span class="number">48.21</span></span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="title function_">expect</span>(<span class="title function_">latestEmission</span>()).<span class="title function_">toEqual</span>(&#123;</span><br><span class="line">            <span class="attr">XOM</span>: <span class="number">48.21</span>,</span><br><span class="line">            <span class="attr">BA</span>: <span class="number">218.93</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="title function_">it</span>(<span class="string">&#x27;should emit empty object after resetPrices$ emits&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// call next() on the subject that mocks out the source observable</span></span><br><span class="line">        <span class="comment">// resetPrices$ that the observable under test depends on, to simulate</span></span><br><span class="line">        <span class="comment">// that observable emitting, and ensure that the prices lookup table</span></span><br><span class="line">        <span class="comment">// is reset to an empty object</span></span><br><span class="line">        mockResetPrices$.<span class="title function_">next</span>()</span><br><span class="line">        <span class="title function_">expect</span>(<span class="title function_">latestEmission</span>()).<span class="title function_">toEqual</span>(&#123;&#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="title function_">it</span>(<span class="string">&#x27;should emit object containing only the latest prices after pricesDto$ emits&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        mockPricesDto$.<span class="title function_">next</span>(&#123;</span><br><span class="line">            <span class="attr">symbol</span>: <span class="string">&#x27;HD&#x27;</span>,</span><br><span class="line">            <span class="attr">price</span>: <span class="number">332.12</span></span><br><span class="line">        &#125;)</span><br><span class="line">        mockPricesDto$.<span class="title function_">next</span>(&#123;</span><br><span class="line">            <span class="attr">symbol</span>: <span class="string">&#x27;AA&#x27;</span>,</span><br><span class="line">            <span class="attr">price</span>: <span class="number">24.49</span></span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="title function_">expect</span>(<span class="title function_">latestEmission</span>()).<span class="title function_">toEqual</span>(&#123;</span><br><span class="line">            <span class="attr">HD</span>: <span class="number">332.12</span>,</span><br><span class="line">            <span class="attr">AA</span>: <span class="number">24.49</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="title function_">it</span>(<span class="string">&#x27;should not error&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">expect</span>(error).<span class="property">not</span>.<span class="title function_">toBeCalled</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>…我们的测试不通过</p>
<p><img src="/2024/04/15/unit-testing-rxjs-observables-a-practical-guide/image-3.png" alt="alt text"></p>
<p>RxJS 可观察对象: 第 5 阶段——测试失败</p>
<p>看来我们的测试发现了实现中的一个 bug ! 我们希望在 reset 可观察对象发出时将状态重置为空对象。但是我们传递给 scan()的 reducer 函数中的 accumulator 对象即使在重置之后也会保留状态。让我们通过在 scan()之前移动 mergeWith()来解决这个问题，并在 reducer 函数中添加一个条件，以便在重置事件中用空对象替换状态。(在这种情况下，流入 scan()的值将是 false 而不是 Price 对象。)</p>
<p>Stage 6: state.ts</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">    <span class="title class_">Observable</span>,</span><br><span class="line">    mergeWith,</span><br><span class="line">    scan,</span><br><span class="line">    startWith</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">    pricesDto$,</span><br><span class="line">    resetPrices$</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&quot;./service&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">    <span class="title class_">Price</span></span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&quot;./model&quot;</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="attr">prices$</span>: <span class="title class_">Observable</span> &lt; <span class="title class_">Record</span> &lt; string, number &gt;&gt; = pricesDto$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">mergeWith</span>(resetPrices$),</span><br><span class="line">    <span class="title function_">scan</span>(</span><br><span class="line">        <span class="function">(<span class="params">accum, current: Price | <span class="keyword">void</span></span>) =&gt;</span></span><br><span class="line">        !current ?</span><br><span class="line">        &#123;&#125; :</span><br><span class="line">        &#123;</span><br><span class="line">            ...accum,</span><br><span class="line">            [current.<span class="property">symbol</span>]: current.<span class="property">price</span>,</span><br><span class="line">        &#125;, &#123;&#125;</span><br><span class="line">    ),</span><br><span class="line">    <span class="title function_">startWith</span>(&#123;&#125;)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>我们的测试现在又通过了，这给了我们信心，我们的观察链做了我们想要它做的事情。</p>
<p><img src="/2024/04/15/unit-testing-rxjs-observables-a-practical-guide/image-4.png" alt="alt text"></p>
<h2 id="RxJS-观察链单元测试-解决方案概述-1"><a href="#RxJS-观察链单元测试-解决方案概述-1" class="headerlink" title="RxJS 观察链单元测试: 解决方案概述"></a>RxJS 观察链单元测试: 解决方案概述</h2><p>spyOnObservable 实用程序提供了一个易于使用的 API 来监视可观察对象，以方便断言它们的行为。这个实用程序与 RxJS Subjects 模拟上游可观察对象配对，定义了一个可扩展的模式，用于编写语法愉悦的单元测试，模拟观察链在现实世界中的行为，通过上游源可观察对象提供各种输入。</p>
<p>你可以随意复制 spyOnObservable，根据你认为合适的需要进行调整，并使用它而不注明出处。</p>
<h2 id="进一步的资源"><a href="#进一步的资源" class="headerlink" title="进一步的资源"></a>进一步的资源</h2><p>如果您有兴趣了解更多关于如何实现响应式编程原则的信息，请参阅 reactive Trader® 及其开源代码库。Reactive Trader® 是 Adaptive 的实时外汇(FX)和信用交易平台，旨在展示整个应用程序堆栈的反应性编程原则。</p>
<p>如果你想了解 React-RxJS，一个提供绑定来将 RxJS 可观察对象与 React 集成的库，请参阅我们 2020 年的文章 Why React RxJS。</p>
<h2 id="附录-A-考虑单元测试-RxJS-观察链的替代解决方案"><a href="#附录-A-考虑单元测试-RxJS-观察链的替代解决方案" class="headerlink" title="附录 A: 考虑单元测试 RxJS 观察链的替代解决方案"></a>附录 A: 考虑单元测试 RxJS 观察链的替代解决方案</h2><p>Marble 测试非常适合测试 RxJS 操作符(如 map()、first()等)。例如，创建操作符函数的工厂函数。事实上，RxJS 代码库中 RxJS 操作符的单元测试使用大理石测试。当测试一个接受一个可观察对象并返回另一个可观察对象的函数时，大理石测试也很有用。</p>
<p>然而，对于我们测试有状态观察链的用例，大理石测试似乎并不适合。此外，大理石测试对整个产生的排放流起作用。我们希望能够以交互的方式测试游戏中排放的内容，这样我们就可以在每次排放后通过可观测源验证预期结果。</p>
<p>我们简要探讨的另一种方法是订阅可观察对象，并在观察者中进行测试断言(例如，将下一个处理程序传递给 subscribe())。这对于发出多个值的可观察对象来说效果很差，它只在你知道可观察对象将完成时才有效，并且需要样板文件来处理在可观察对象完成时实现异步测试的承诺。在某种程度上，您可以通过使用 take()等操作符强制完成(但是您需要确切地知道要关注多少次释放)，以及 toArray()来检查释放的多个值，从而解决这个问题。我们发现这种方法并不令人满意。</p>
<p>Author: Bruce Harris</p>
<p><a target="_blank" rel="noopener" href="https://weareadaptive.com/2024/01/09/unit-testing-rxjs-observables-a-practical-guide/">原文链接：https://weareadaptive.com/2024/01/09/unit-testing-rxjs-observables-a-practical-guide/</a></p>

      
    </div>
    
    
    
  </div>
</article>



  




    </div>
  </div>
    
<div id="settings-container">
  <div id="to-top" onclick="window.scrollTo({left: 0, top: 0,behavior: 'smooth' })">Top</div>
  <div id="dark-mode">dark</div>
  <div id="sans-font">sans</div>
</div>
<script type="text/javascript">
  let d = document,
    style = d.documentElement.style,
    setProperty = style.setProperty.bind(style),
    ls = localStorage,
    mode = ls.getItem("mode") || (window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches),
    sans = ls.getItem("sans"),
    darkMode = d.getElementById("dark-mode"),
    darkFun = () => {
      setProperty("--bg-color", "#fafafa");
      setProperty("--code-bg-color", "#f4f4f4");
      setProperty("--text-color", "#212121");
      setProperty("--secondary-color", "#808080");
      setProperty("--tertiary-color", "#b0b0b0");
      setProperty("--link-color", "#b5c8cf");
      setProperty("--link-hover-color", "#618794");
      setProperty("--link-bg-color", "#dae4e7");
      setProperty("--selection-color", "#dae4e7");
      darkMode.innerHTML = "dark";
    },
    lightFun = () => {
      setProperty("--bg-color", "#212121");
      setProperty("--code-bg-color", "#292929");
      setProperty("--text-color", "#fff");
      setProperty("--secondary-color", "#c0c0c0");
      setProperty("--tertiary-color", "#6e6e6e");
      setProperty("--link-color", "#4d6b75");
      setProperty("--link-hover-color", "#96b1bb");
      setProperty("--link-bg-color", "#5d828e");
      setProperty("--selection-color", "#acc1c9");
      darkMode.innerHTML = "light";
    },
    sansFont = d.getElementById("sans-font"),
    sansFun = () => {
      setProperty("--body-stack", '"Lora", "Georgia", "Times New Roman", serif');
      sansFont.innerHTML = "sans";
    },
    serifFun = () => {
      setProperty("--body-stack", '"Lato", "Lucida Grande", "Lucida Sans Unicode", "Lucida Sans", "Verdana", sans-serif');
      sansFont.innerHTML = "serif";
    };
  darkMode.onclick = () => {
    if (mode == 2) {
      mode = 1;
      ls.setItem("mode", mode);
      lightFun();
    } else {
      mode = 2;
      ls.setItem("mode", mode);
      darkFun();
    }
  };
  sansFont.onclick = () => {
    if (sans == 2) {
      sans = 1;
      ls.setItem("sans", sans);
      serifFun();
    } else {
      sans = 2;
      ls.setItem("sans", sans);
      sansFun();
    }
  };
  if (!mode) {
    mode = 2;
    ls.setItem("mode", 2);
  }
  if (mode == 1) {
    lightFun();
  }
  if (!sans) {
    sans = 2;
    ls.setItem("sans", 2);
  }
  if (sans == 1) {
    serifFun();
  }
</script>
 

</body>
</html>
